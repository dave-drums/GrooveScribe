<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Embedded Groove</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="./js/groove_display.js"></script>

    <!-- Font (Mulish = modern Muli replacement) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap">

    <style>
      html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      /* Apply font */
      .gs-embed, .gs-embed *{
        font-family:"Mulish", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
/* Remove SWING row */
      .swingRow {
        display: none !important;
      }

      /* ===========================
         EMBEDDED PLAYER STYLES
         =========================== */

      /* Centre BPM row vertically */
      .gs-embed [id^="tempoAndProgress"] .tempoRow {
        display: flex !important;
        align-items: center !important;
        height: 40px !important; /* clean centering */
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }

      /* BPM button group */
      .gs-embed [id^="tempoAndProgress"] .bpmBtns{
        display:inline-flex;
        align-items:center;
        gap:10px;
        margin-left:4px;
      }
      
      .gs-embed [id^="tempoAndProgress"] .bpmBtn{
        width:32px;
        height:32px;
        border-radius:999px;
        background:transparent;
        border:2px solid #8c8c8c;
        color:#8c8c8c;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:17px;
        font-weight:800;
        line-height:1;
        cursor:pointer;
        user-select:none;
        box-sizing:border-box;
        margin:0;
      }
      
      @media (max-width: 600px){
        .gs-embed [id^="tempoAndProgress"] .bpmBtn{
          width:32px;
          height:32px;
        }
      }
      
      .gs-embed [id^="tempoAndProgress"] .bpmBtn:hover{
        background:rgba(140,140,140,.08);
      }

      .gs-embed [id^="tempoAndProgress"] .bpmBtn:active{
        transform:translateY(1px);
      }

      /* Style BPM number (###) only */
      .gs-embed [id^="tempoAndProgress"] input[id^="tempoTextField"],
      .gs-embed [id^="tempoAndProgress"] .tempoTextField{
        font-size:16px !important;
        font-weight:700 !important;
        line-height:1 !important;
      /* Align BPM number with "BPM" text baseline */
        vertical-align:baseline !important;
        position:relative;
        top:-2px; /* adjust -1px or -2px if needed */
      /* Prevent BPM number side clipping */
          padding-top: 1px !important;
        padding-bottom: 1px !important;
        padding-left: 2px !important;
        padding-right: 2px !important;
        min-width: 3ch !important;
      }

      
      /* Hide the original BPM slider entirely */
      .gs-embed [id^="tempoAndProgress"] .tempoRow input[type="range"]{
        display:none !important;
      }

      /* Hide GrooveScribe logo button (inline SVG in your build) */
      .gs-embed .midiGSLogo,
      .gs-embed [id^="midiGSLogo"]{
        display:none !important;
        pointer-events:none !important;
      }
    </style>
  </head>

  <body class="gs-embed">
    <script>
      GrooveDisplay.AddGrooveDisplayToPage(location.search, true, true);
    </script>

    <script>
      (function(){
        function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

        function hideGsLogoHard(){
          // Some builds re-apply styles after render; force-hide via inline style too.
          document.querySelectorAll(".midiGSLogo,[id^='midiGSLogo']").forEach(function(el){
            el.style.display = "none";
            el.style.pointerEvents = "none";
          });
        }

        function injectIntoWrap(wrap){
          if(!wrap) return;

          hideGsLogoHard();

          var tempoRow = wrap.querySelector(".tempoRow");
          var tempoField =
            wrap.querySelector('[id^="tempoTextField"]') ||
            wrap.querySelector(".tempoTextField") ||
            wrap.querySelector('input[type="text"]');

          if(!tempoRow || !tempoField) return;

          // Prevent duplicate injection per instance
          if(tempoRow.querySelector(".bpmBtns")) return;

          // Make BPM field editable (text + buttons both control tempo)
          tempoField.readOnly = false;
          tempoField.style.cursor = "text";
          
          // Forward typed BPM changes to the hidden slider (GS source of truth)
          tempoField.addEventListener("change", function(){
            var slider = wrap.querySelector('input[type="range"]');
            if(!slider) return;
            var v = parseInt(tempoField.value, 10);
            if(Number.isNaN(v)) return;
            v = clamp(v, 30, 300);
            slider.value = String(v);
            tempoField.value = String(v);
            
            slider.dispatchEvent(new Event("input", { bubbles:true }));
            slider.dispatchEvent(new Event("change", { bubbles:true }));
          });

          var btnWrap = document.createElement("span");
          btnWrap.className = "bpmBtns";
          btnWrap.innerHTML =
            '<span class="bpmBtn" data-d="-5">–</span>' +
            '<span class="bpmBtn" data-d="5">+</span>';

          tempoRow.appendChild(btnWrap);

          btnWrap.addEventListener("click", function(e){
            var btn = e.target.closest(".bpmBtn");
            if(!btn) return;

            var delta = parseInt(btn.getAttribute("data-d"), 10) || 0;

            // Drive the hidden slider: this is what GrooveScribe reliably listens to
            var slider = wrap.querySelector('input[type="range"]');
            if(!slider) return;

            var cur = parseInt(slider.value, 10);
            if(Number.isNaN(cur)) cur = parseInt(tempoField.value, 10) || 80;

            var next = clamp(cur + delta, 30, 300);

            slider.value = String(next);
            tempoField.value = String(next);

            slider.dispatchEvent(new Event("input", { bubbles: true }));
            slider.dispatchEvent(new Event("change", { bubbles: true }));
          });
        }

        function injectAll(){
          hideGsLogoHard();
          document.querySelectorAll('[id^="tempoAndProgress"]').forEach(function(wrap){
            injectIntoWrap(wrap);
          });
        }

        // GrooveScribe builds UI async — retry briefly
        var tries = 0;
        var iv = setInterval(function(){
          tries++;
          injectAll();

          // Stop once every instance has buttons (or we time out)
          var wraps = document.querySelectorAll('[id^="tempoAndProgress"]');
          var allDone = wraps.length > 0 && Array.prototype.every.call(wraps, function(w){
            var row = w.querySelector(".tempoRow");
            return row && row.querySelector(".bpmBtns");
          });

          if(allDone || tries > 120){
            clearInterval(iv);
          }
        }, 50);
      })();
    </script>

    <script>
      function sendGrooveHeight() {
        var container = document.body;
        var height =
          container.scrollHeight ||
          container.getBoundingClientRect().height ||
          0;

        height = Math.ceil(height) + 20;

        window.parent.postMessage(
          { type: "grooveHeight", height: height },
          "*"
        );
      }

      window.addEventListener("load", function () {
        setTimeout(sendGrooveHeight, 200);
      });

      window.addEventListener("resize", function () {
        setTimeout(sendGrooveHeight, 100);
      });
    </script>
  </body>
</html>
