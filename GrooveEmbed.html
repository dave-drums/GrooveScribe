<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Embedded Groove</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="./js/groove_display.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      /* Remove SWING row */
      .swingRow {
        display: none !important;
      }

      /* ===========================
         EMBED-ONLY SCALABLE STYLES
         Targets ALL instances:
         tempoAndProgress1, 2, 3...
         =========================== */

      /* Centre BPM row vertically */
      .gs-embed [id^="tempoAndProgress"] .tempoRow {
        display: flex !important;
        align-items: center !important;
        height: 40px !important; /* clean centering */
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }

      /* BPM button group */
      .gs-embed [id^="tempoAndProgress"] .bpmBtns{
        display:flex;
        align-items:center;
        gap:6px;
        margin-left:10px;
      }

      .gs-embed [id^="tempoAndProgress"] .bpmBtn{
        width: 28px;
        height: 28px;
        border: 2px solid rgba(0,0,0,0.25);
        border-radius: 999px;
        background: transparent;
        color: #878795;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        font-weight: 600;
        line-height: 1;
        cursor: pointer;
        user-select: none;
      }

      .gs-embed [id^="tempoAndProgress"] .bpmBtn:active{
        transform:translateY(1px);
      }

      /* BPM text field */
      .gs-embed [id^="tempoAndProgress"] .tempoTextField,
      .gs-embed [id^="tempoAndProgress"] input[id^="tempoTextField"]{
        background:transparent !important;
        color: #878795;
        border: 2px solid rgba(0,0,0,0.25) !important;
        border-radius:8px !important;
        height:28px !important;
        width:28px !important;
        padding: 0 5px;
        text-align:center !important;
        font-size:15px !important;
        font-weight:600 !important;
        outline:none !important;
        
      }

      .gs-embed [id^="tempoAndProgress"] .tempoTextField:focus,
      .gs-embed [id^="tempoAndProgress"] input[id^="tempoTextField"]:focus{
        box-shadow:none !important;
      }

      /* Hide the BPM slider entirely (we drive it programmatically) */
      .gs-embed [id^="tempoAndProgress"] .tempoRow input[type="range"]{
        display:none !important;
      }
@media (max-width: 600px){
  .gs-embed [id^="tempoAndProgress"] .tempoTextField,
  .gs-embed [id^="tempoAndProgress"] input[id^="tempoTextField"]{
    font-size:15px !important;
  }
}

      /* Hide GrooveScribe logo button (inline SVG in your build) */
      .gs-embed .midiGSLogo,
      .gs-embed [id^="midiGSLogo"]{
        display:none !important;
        pointer-events:none !important;
      }
    </style>
  </head>

  <body class="gs-embed">
    <script>
      GrooveDisplay.AddGrooveDisplayToPage(location.search, true, true);
    </script>

    <script>
      (function(){
        function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

        function hideGsLogoHard(){
          // Some builds re-apply styles after render; force-hide via inline style too.
          document.querySelectorAll(".midiGSLogo,[id^='midiGSLogo']").forEach(function(el){
            el.style.display = "none";
            el.style.pointerEvents = "none";
          });
        }

        function injectIntoWrap(wrap){
          if(!wrap) return;

          hideGsLogoHard();

          var tempoRow = wrap.querySelector(".tempoRow");
          var tempoField =
            wrap.querySelector('[id^="tempoTextField"]') ||
            wrap.querySelector(".tempoTextField") ||
            wrap.querySelector('input[type="text"]');

          if(!tempoRow || !tempoField) return;

          // Prevent duplicate injection per instance
          if(tempoRow.querySelector(".bpmBtns")) return;

          // Keep BPM field editable
          tempoField.readOnly = false;
          tempoField.style.cursor = "text";

          var btnWrap = document.createElement("span");
          btnWrap.className = "bpmBtns";

          // Order: -5, BPM ### (existing field), +5
          btnWrap.innerHTML =
            '<span class="bpmBtn" data-d="-5">–5</span>' +
            '<span class="bpmBtn" data-d="5">+5</span>';

          // Insert buttons right after the BPM field (keeps layout: -1 -5 [BPM] +5 +1)
          // If the BPM field is inside the row, insert buttons immediately after it.
          if (tempoField.parentNode === tempoRow) {
            tempoRow.insertBefore(btnWrap, tempoField.nextSibling);
          } else {
            // Fallback: append to row
            tempoRow.appendChild(btnWrap);
          }

          btnWrap.addEventListener("click", function(e){
            var btn = e.target.closest(".bpmBtn");
            if(!btn) return;

            var delta = parseInt(btn.getAttribute("data-d"), 10) || 0;

            // Drive the hidden slider: this is what GrooveScribe reliably listens to
            var slider = wrap.querySelector('input[type="range"]');
            if(!slider) return;

            var cur = parseInt(slider.value, 10);
            if(Number.isNaN(cur)) cur = parseInt(tempoField.value, 10) || 80;

            var next = clamp(cur + delta, 30, 300);

            slider.value = String(next);
            tempoField.value = String(next);

            slider.dispatchEvent(new Event("input", { bubbles: true }));
            slider.dispatchEvent(new Event("change", { bubbles: true }));
          });
        }

        function injectAll(){
          hideGsLogoHard();
          document.querySelectorAll('[id^="tempoAndProgress"]').forEach(function(wrap){
            injectIntoWrap(wrap);
          });
        }

        // GrooveScribe builds UI async — retry briefly
        var tries = 0;
        var iv = setInterval(function(){
          tries++;
          injectAll();

          // Stop once every instance has buttons (or we time out)
          var wraps = document.querySelectorAll('[id^="tempoAndProgress"]');
          var allDone = wraps.length > 0 && Array.prototype.every.call(wraps, function(w){
            var row = w.querySelector(".tempoRow");
            return row && row.querySelector(".bpmBtns");
          });

          if(allDone || tries > 120){
            clearInterval(iv);
          }
        }, 50);
      })();
    </script>

    <script>
      function sendGrooveHeight() {
        var container = document.body;
        var height =
          container.scrollHeight ||
          container.getBoundingClientRect().height ||
          0;

        height = Math.ceil(height) + 20;

        window.parent.postMessage(
          { type: "grooveHeight", height: height },
          "*"
        );
      }

      window.addEventListener("load", function () {
        setTimeout(sendGrooveHeight, 200);
      });

      window.addEventListener("resize", function () {
        setTimeout(sendGrooveHeight, 100);
      });
    </script>
  </body>
</html>
