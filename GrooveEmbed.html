<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Embedded Groove</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="./js/groove_display.js"></script>

    <!-- Font (Mulish = modern Muli replacement) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap">

    <style>
      html, body{
        margin:0;
        padding:0;
        overflow:hidden;
      }

      /* Embed-only font */
      .gs-embed, .gs-embed *{
        font-family:"Mulish", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      /* Hide swing */
      .swingRow{ display:none !important; }

      /* Hide GrooveScribe logo (inline SVG) */
      .gs-embed .midiGSLogo,
      .gs-embed [id^="midiGSLogo"]{
        display:none !important;
        pointer-events:none !important;
      }

      /* Hide tempo slider */
      .gs-embed [id^="tempoAndProgress"] .tempoRow input[type="range"]{
        display:none !important;
      }

      /* Keep tempo row nicely centred */
      .gs-embed [id^="tempoAndProgress"] .tempoRow{
        display:flex !important;
        align-items:center !important;
        height:40px !important;
        padding:0 !important;
      }

      /* BPM input box */
      .gs-embed [id^="tempoAndProgress"] input[id^="tempoTextField"],
      .gs-embed [id^="tempoAndProgress"] .tempoTextField{
        background:transparent !important;
        color:inherit !important;
        border:1px solid rgba(0,0,0,.25) !important;
        border-radius:999px !important;
        height:30px !important;
        width:30px !important;
        padding:0 6px !important;
        text-align:center !important;
        font-weight:600 !important;
        font-size:14px !important;
        outline:none !important;
        box-sizing:border-box !important;
      }

      /* Ensure the BPM label stays normal (not tiny/superscript) */
      .gs-embed [id^="tempoAndProgress"] .tempoLabel{
        font-size:15px !important;
        vertical-align:baseline !important;
        margin:0 !important;
      }

      /* BPM buttons: outlined circles, play-button grey */
      .gs-embed .bpmBtn{
        width:30px;
        height:30px;
        border-radius:999px;
        background:transparent;
        border:1px solid #8c8c8c;
        color:#8c8c8c;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:13px;
        font-weight:600;
        line-height:1;
        cursor:pointer;
        user-select:none;
        box-sizing:border-box;
        margin:0 4px;
      }
      .gs-embed .bpmBtn:hover{ background:rgba(140,140,140,.08); }
      .gs-embed .bpmBtn:active{ background:rgba(140,140,140,.15); transform:translateY(1px); }

      @media (max-width:600px){
        .gs-embed .bpmBtn{
          width:32px;
          height:32px;
          font-size:12px;
        }
        .gs-embed [id^="tempoAndProgress"] input[id^="tempoTextField"],
        .gs-embed [id^="tempoAndProgress"] .tempoTextField{
          height:34px !important;
          width:40px !important;
          padding:0 6px !important;
          font-size:15px !important;
        }
      }
    </style>
  </head>

  <body class="gs-embed">
    <script>
      GrooveDisplay.AddGrooveDisplayToPage(location.search, true, true);
    </script>

    <script>
      (function(){
        function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

        function hardHideLogo(){
          document.querySelectorAll(".midiGSLogo,[id^='midiGSLogo']").forEach(function(el){
            el.style.display = "none";
            el.style.pointerEvents = "none";
          });
        }

        function injectOnce(){
          hardHideLogo();

          document.querySelectorAll('[id^="tempoAndProgress"]').forEach(function(wrap){
            var tempoRow = wrap.querySelector(".tempoRow");
            var tempoField = wrap.querySelector('input[id^="tempoTextField"], .tempoTextField');
            if(!tempoRow || !tempoField) return;

            // If GS re-renders, tempoRow may change; guard per-row instance
            if(tempoRow.querySelector(".bpmBtns")) return;

            // Clean up any stray buttons from earlier buggy injections
            tempoRow.querySelectorAll(".bpmBtn").forEach(function(el){
              if(!el.closest(".bpmBtns")) el.remove();
            });

            // Create wrapper and buttons
            var btnWrap = document.createElement("span");
            btnWrap.className = "bpmBtns";

            var minusBtn = document.createElement("span");
            minusBtn.className = "bpmBtn";
            minusBtn.textContent = "â€“5";
            minusBtn.dataset.d = "-5";

            var plusBtn = document.createElement("span");
            plusBtn.className = "bpmBtn";
            plusBtn.textContent = "+5";
            plusBtn.dataset.d = "5";

            btnWrap.appendChild(minusBtn);
            btnWrap.appendChild(plusBtn);

            // Insert buttons immediately after the BPM input
            if(tempoField.parentNode === tempoRow){
              tempoRow.insertBefore(btnWrap, tempoField.nextSibling);
            }else{
              tempoRow.appendChild(btnWrap);
            }

            // Attach click handler once per row
            if(tempoRow.dataset.bpmListener !== "1"){
              tempoRow.dataset.bpmListener = "1";
              tempoRow.addEventListener("click", function(e){
                var btn = e.target.closest(".bpmBtn");
                if(!btn) return;

                var delta = parseInt(btn.dataset.d, 10) || 0;

                var slider = wrap.querySelector('input[type="range"]');
                if(!slider) return;

                var cur = parseInt(slider.value, 10);
                if(Number.isNaN(cur)) cur = parseInt(tempoField.value, 10) || 80;

                var next = clamp(cur + delta, 30, 300);

                slider.value = String(next);
                tempoField.value = String(next);

                slider.dispatchEvent(new Event("input", { bubbles:true }));
                slider.dispatchEvent(new Event("change", { bubbles:true }));
              });
            }
          });

        }

        // GS renders async; retry briefly
        var tries = 0;
        var iv = setInterval(function(){
          injectOnce();
          if(++tries > 120) clearInterval(iv);
        }, 50);
      })();
    </script>

    <script>
      function sendGrooveHeight(){
        var h = Math.ceil(document.body.scrollHeight) + 20;
        window.parent.postMessage({ type:"grooveHeight", height:h }, "*");
      }
      window.addEventListener("load", function(){ setTimeout(sendGrooveHeight, 200); });
      window.addEventListener("resize", function(){ setTimeout(sendGrooveHeight, 100); });
    </script>
  </body>
</html>
