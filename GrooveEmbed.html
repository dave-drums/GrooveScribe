<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Embedded Groove</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- GrooveScribe -->
    <script src="./js/groove_display.js"></script>

    <!-- Font (Mulish = modern Muli replacement) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap">

    <style>
      html, body{
        margin:0;
        padding:0;
        overflow:hidden;
      }

      .gs-embed,
      .gs-embed *{
        font-family: "Mulish", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      /* Hide swing slider */
      .swingRow{ display:none !important; }

      /* Hide GS logo */
      .gs-embed .midiGSLogo,
      .gs-embed [id^="midiGSLogo"]{
        display:none !important;
        pointer-events:none !important;
      }

      /* Hide tempo slider */
      .gs-embed [id^="tempoAndProgress"] input[type="range"]{
        display:none !important;
      }

      /* BPM input */
      .gs-embed input[id^="tempoTextField"]{
        background:transparent !important;
        color:inherit !important;
        border:1px solid rgba(0,0,0,.25) !important;
        border-radius:999px !important;
        height:34px !important;
        width:50px !important;
        padding:0 5px;
        text-align:center !important;
        font-weight:600 !important;
        font-size:14px !important;
        outline:none !important;
      }

      /* BPM buttons */
      .gs-embed .bpmBtn{
        width:28px;
        height:28px;
        border-radius:999px;
        background:transparent;
        border:0px solid #8c8c8c;
        color:#8c8c8c;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:11px;
        font-weight:600;
        cursor:pointer;
        user-select:none;
        margin:0 4px;
      }

      .gs-embed .bpmBtn:hover{
        background:rgba(140,140,140,.08);
      }

      .gs-embed .bpmBtn:active{
        background:rgba(140,140,140,.15);
        transform:translateY(1px);
      }

      /* Mobile tweaks */
      @media (max-width:600px){
        .gs-embed .bpmBtn{
          font-size:12px;
        }

        .gs-embed input[id^="tempoTextField"]{
          width:40px !important;
          font-size:16px !important;
        }
      }
    </style>
  </head>

  <body class="gs-embed">
    <script>
      GrooveDisplay.AddGrooveDisplayToPage(location.search, true, true);
    </script>

    <script>
      (function(){
        function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

        function inject(){
          document.querySelectorAll('[id^="tempoAndProgress"]').forEach(function(wrap){
            var tempoRow = wrap.querySelector(".tempoRow");
            var tempoField = wrap.querySelector('input[id^="tempoTextField"]');
            if(!tempoRow || !tempoField) return;

            // prevent duplicate injection
            if(tempoRow.dataset.bpmInjected === "1") return;
            tempoRow.dataset.bpmInjected = "1";

            var minusBtn = document.createElement("span");
            minusBtn.className = "bpmBtn";
            minusBtn.textContent = "â€“5";
            minusBtn.dataset.d = "-5";

            var plusBtn = document.createElement("span");
            plusBtn.className = "bpmBtn";
            plusBtn.textContent = "+5";
            plusBtn.dataset.d = "5";

            var bpmLabel = wrap.querySelector(".tempoLabel");

            if(bpmLabel && bpmLabel.parentNode === tempoRow){
              tempoRow.insertBefore(minusBtn, bpmLabel);
            }else{
              tempoRow.insertBefore(minusBtn, tempoField);
            }

            tempoRow.insertBefore(plusBtn, tempoField.nextSibling);

            tempoRow.addEventListener("click", function(e){
              var btn = e.target.closest(".bpmBtn");
              if(!btn) return;

              var delta = parseInt(btn.dataset.d,10);
              var slider = wrap.querySelector('input[type="range"]');
              if(!slider) return;

              var cur = parseInt(slider.value,10);
              if(isNaN(cur)) cur = parseInt(tempoField.value,10) || 80;

              var next = clamp(cur + delta, 30, 300);

              slider.value = next;
              tempoField.value = next;
              slider.dispatchEvent(new Event("input",{bubbles:true}));
              slider.dispatchEvent(new Event("change",{bubbles:true}));
            });
          });
        }

        var tries = 0;
        var iv = setInterval(function(){
          inject();
          if(++tries > 120) clearInterval(iv);
        },50);
      })();
    </script>

    <script>
      function sendGrooveHeight(){
        var h = Math.ceil(document.body.scrollHeight) + 20;
        window.parent.postMessage({type:"grooveHeight",height:h},"*");
      }
      window.addEventListener("load",()=>setTimeout(sendGrooveHeight,200));
      window.addEventListener("resize",()=>setTimeout(sendGrooveHeight,100));
    </script>
  </body>
</html>
